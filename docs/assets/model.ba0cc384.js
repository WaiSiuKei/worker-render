var Ln=Object.defineProperty;var An=(x,B,q)=>B in x?Ln(x,B,{enumerable:!0,configurable:!0,writable:!0,value:q}):x[B]=q;var o=(x,B,q)=>(An(x,typeof B!="symbol"?B+"":B,q),q);(function(){var xe;"use strict";function x(e){const n=this;let t=!1,i;return function(){return t||(t=!0,i=e.apply(n,arguments)),i}}var B;(e=>{function n(a){return a&&typeof a=="object"&&typeof a[Symbol.iterator]=="function"}e.is=n;const t=Object.freeze([]);function i(){return t}e.empty=i;function*s(a){yield a}e.single=s;function _(a){return a||t}e.from=_;function l(a){return!a||a[Symbol.iterator]().next().done===!0}e.isEmpty=l;function r(a){return a[Symbol.iterator]().next().value}e.first=r;function U(a,D){for(const b of a)if(D(b))return!0;return!1}e.some=U;function g(a,D){for(const b of a)if(D(b))return b}e.find=g;function*R(a,D){for(const b of a)D(b)&&(yield b)}e.filter=R;function*L(a,D){let b=0;for(const d of a)yield D(d,b++)}e.map=L;function*T(...a){for(const D of a)for(const b of D)yield b}e.concat=T;function*A(a){for(const D of a)for(const b of D)yield b}e.concatNested=A;function S(a,D,b){let d=b;for(const E of a)d=D(d,E);return d}e.reduce=S;function*h(a,D,b=a.length){for(D<0&&(D+=a.length),b<0?b+=a.length:b>a.length&&(b=a.length);D<b;D++)yield a[D]}e.slice=h;function X(a,D=Number.POSITIVE_INFINITY){const b=[];if(D===0)return[b,a];const d=a[Symbol.iterator]();for(let E=0;E<D;E++){const c=d.next();if(c.done)return[b,e.empty()];b.push(c.value)}return[b,{[Symbol.iterator](){return d}}]}e.consume=X;function N(a,D,b=(d,E)=>d===E){const d=a[Symbol.iterator](),E=D[Symbol.iterator]();for(;;){const c=d.next(),u=E.next();if(c.done!==u.done)return!1;if(c.done)return!0;if(!b(c.value,u.value))return!1}}e.equals=N})(B||(B={}));function q(e){return typeof e>"u"}const ve=e=>typeof e=="function";function He(e){return q(e)||e===null}let F=null;function C(e){return F==null||F.trackDisposable(e),e}function ee(e){F==null||F.markAsDisposed(e)}function Te(e,n){F==null||F.setParent(e,n)}class We extends Error{constructor(n){super(`Encountered errors while disposing of store. Errors: [${n.join(", ")}]`),this.errors=n}}function ne(e){if(B.is(e)){const n=[];for(const t of e)if(t)try{t.dispose()}catch(i){n.push(i)}if(n.length===1)throw n[0];if(n.length>1)throw new We(n);return Array.isArray(e)?[]:e}else if(e)return e.dispose(),e}function Ie(...e){return Y(()=>ne(e))}function Y(e){const n=C({dispose:x(()=>{ee(n),e()})});return n}const Ae=class{constructor(){o(this,"_toDispose",new Set);o(this,"_isDisposed",!1);C(this)}dispose(){this._isDisposed||(ee(this),this._isDisposed=!0,this.clear())}get isDisposed(){return this._isDisposed}clear(){try{ne(this._toDispose.values())}finally{this._toDispose.clear()}}add(n){if(!n)return n;if(n===this)throw new Error("Cannot register a disposable on itself!");return Te(n,this),this._isDisposed?Ae.DISABLE_DISPOSED_WARNING||console.warn(new Error("Trying to add a disposable to a DisposableStore that has already been disposed of. The added object will be leaked!").stack):this._toDispose.add(n),n}};let G=Ae;o(G,"DISABLE_DISPOSED_WARNING",!1);class te{constructor(){o(this,"$$disposed",!1);o(this,"_store",new G);C(this),Te(this._store,this)}dispose(){this.$$disposed=!0,ee(this),this._store.dispose()}_register(n){if(n===this)throw new Error("Cannot register a disposable on itself!");return this._store.add(n)}}o(te,"None",Object.freeze({dispose(){}}));class qe{constructor(){o(this,"dispose",()=>{});o(this,"unset",()=>{});o(this,"isset",()=>!1);C(this)}set(n){let t=n;return this.unset=()=>t=void 0,this.isset=()=>t!==void 0,this.dispose=()=>{t&&(t(),t=void 0,ee(this))},this}}const Z=class{constructor(n){o(this,"element");o(this,"next");o(this,"prev");this.element=n,this.next=Z.Undefined,this.prev=Z.Undefined}};let I=Z;o(I,"Undefined",new Z(void 0));class me{constructor(){o(this,"_first",I.Undefined);o(this,"_last",I.Undefined);o(this,"_size",0)}get size(){return this._size}isEmpty(){return this._first===I.Undefined}clear(){this._first=I.Undefined,this._last=I.Undefined,this._size=0}unshift(n){return this._insert(n,!1)}push(n){return this._insert(n,!0)}_insert(n,t){const i=new I(n);if(this._first===I.Undefined)this._first=i,this._last=i;else if(t){const _=this._last;this._last=i,i.prev=_,_.next=i}else{const _=this._first;this._first=i,i.next=_,_.prev=i}this._size+=1;let s=!1;return()=>{s||(s=!0,this._remove(i))}}shift(){if(this._first!==I.Undefined){const n=this._first.element;return this._remove(this._first),n}}pop(){if(this._last!==I.Undefined){const n=this._last.element;return this._remove(this._last),n}}_remove(n){if(n.prev!==I.Undefined&&n.next!==I.Undefined){const t=n.prev;t.next=n.next,n.next.prev=t}else n.prev===I.Undefined&&n.next===I.Undefined?(this._first=I.Undefined,this._last=I.Undefined):n.next===I.Undefined?(this._last=this._last.prev,this._last.next=I.Undefined):n.prev===I.Undefined&&(this._first=this._first.next,this._first.prev=I.Undefined);this._size-=1}*[Symbol.iterator](){let n=this._first;for(;n!==I.Undefined;)yield n.element,n=n.next}}class Ke{constructor(){o(this,"unexpectedErrorHandler");o(this,"listeners");this.listeners=[],this.unexpectedErrorHandler=function(n){setTimeout(()=>{throw n.stack?new Error(n.message+`

`+n.stack):n},0)}}addListener(n){return this.listeners.push(n),()=>{this._removeListener(n)}}emit(n){this.listeners.forEach(t=>{t(n)})}_removeListener(n){this.listeners.splice(this.listeners.indexOf(n),1)}setUnexpectedErrorHandler(n){this.unexpectedErrorHandler=n}getUnexpectedErrorHandler(){return this.unexpectedErrorHandler}onUnexpectedError(n){this.unexpectedErrorHandler(n),this.emit(n)}onUnexpectedExternalError(n){this.unexpectedErrorHandler(n)}}const ze=new Ke;function Ve(e){$e(e)||ze.onUnexpectedError(e)}const Ee="Canceled";function $e(e){return e instanceof V?!0:e instanceof Error&&e.name===Ee&&e.message===Ee}class V extends Error{constructor(){super(Ee),this.name=this.message}}const ie="en";let ae=!1,Oe=!1,se,_e=ie,Xe,H;const k=typeof self=="object"?self:typeof global=="object"?global:{};let O;typeof k.vscode<"u"&&typeof k.vscode.process<"u"?O=k.vscode.process:typeof process<"u"&&(O=process);const we=typeof((xe=O==null?void 0:O.versions)==null?void 0:xe.electron)=="string"&&(O==null?void 0:O.type)==="renderer";if(we&&(O==null||O.sandboxed),typeof navigator=="object"&&!we)H=navigator.userAgent,H.indexOf("Windows")>=0,H.indexOf("Macintosh")>=0,(H.indexOf("Macintosh")>=0||H.indexOf("iPad")>=0||H.indexOf("iPhone")>=0)&&!!navigator.maxTouchPoints&&navigator.maxTouchPoints>0,ae=H.indexOf("Linux")>=0,Oe=!0,se=navigator.language,_e=se;else if(typeof O=="object"){O.platform,O.platform,ae=O.platform==="linux",ae&&!!O.env.SNAP&&O.env.SNAP_REVISION,O.env.CI||O.env.BUILD_ARTIFACTSTAGINGDIRECTORY,se=ie,_e=ie;const e=O.env.VSCODE_NLS_CONFIG;if(e)try{const n=JSON.parse(e),t=n.availableLanguages["*"];se=n.locale,_e=t||ie,Xe=n._translationsConfigFile}catch{}}else console.error("Unable to resolve platform.");Oe&&k.importScripts;const P=H,W=_e;var Me;(e=>{function n(){return W}e.value=n;function t(){return W.length===2?W==="en":W.length>=3?W[0]==="e"&&W[1]==="n"&&W[2]==="-":!1}e.isDefaultVariant=t;function i(){return W==="en"}e.isDefault=i})(Me||(Me={})),(()=>{if(typeof k.postMessage=="function"&&!k.importScripts){const e=[];k.addEventListener("message",t=>{if(t.data&&t.data.vscodeScheduleAsyncWork)for(let i=0,s=e.length;i<s;i++){const _=e[i];if(_.id===t.data.vscodeScheduleAsyncWork){e.splice(i,1),_.callback();return}}});let n=0;return t=>{const i=++n;e.push({id:i,callback:t}),k.postMessage({vscodeScheduleAsyncWork:i},"*")}}return e=>setTimeout(e)})();const je=!!(P&&P.indexOf("Chrome")>=0);P&&P.indexOf("Firefox")>=0,!je&&P&&P.indexOf("Safari")>=0,P&&P.indexOf("Edg/")>=0,P&&P.indexOf("Android")>=0;const Qe=k.performance&&typeof k.performance.now=="function";class fe{constructor(n){o(this,"_highResolution");o(this,"_startTime");o(this,"_stopTime");this._highResolution=Qe&&n,this._startTime=this._now(),this._stopTime=-1}static create(n=!0){return new fe(n)}stop(){this._stopTime=this._now()}elapsed(){return this._stopTime!==-1?this._stopTime-this._startTime:this._now()-this._startTime}_now(){return this._highResolution?k.performance.now():Date.now()}}const De=class{constructor(n){o(this,"_name");o(this,"_stopWatch");o(this,"_listenerCount",0);o(this,"_invocationCount",0);o(this,"_elapsedOverall",0);this._name=`${n}_${De._idPool++}`}start(n){this._stopWatch=new fe(!0),this._listenerCount=n}stop(){if(this._stopWatch){const n=this._stopWatch.elapsed();this._elapsedOverall+=n,this._invocationCount+=1,console.info(`did FIRE ${this._name}: elapsed_ms: ${n.toFixed(5)}, listener: ${this._listenerCount} (elapsed_overall: ${this._elapsedOverall.toFixed(2)}, invocations: ${this._invocationCount})`),this._stopWatch=void 0}}};let oe=De;o(oe,"_idPool",0);let Ye=-1;var w;(e=>{e.None=()=>te.None;function n(E,c){return R(E,()=>{},0,void 0,!0,void 0,c)}e.defer=n;function t(E){return(c,u=null,m)=>{let f=!1,p;return p=E(v=>{if(!f)return p?p.dispose():f=!0,c.call(u,v)},null,m),f&&p.dispose(),p}}e.once=t;function i(E,c,u){return g((m,f=null,p)=>E(v=>m.call(f,c(v)),null,p),u)}e.map=i;function s(E,c,u){return g((m,f=null,p)=>E(v=>{c(v),m.call(f,v)},null,p),u)}e.forEach=s;function _(E,c,u){return g((m,f=null,p)=>E(v=>c(v)&&m.call(f,v),null,p),u)}e.filter=_;function l(E){return E}e.signal=l;function r(...E){return(c,u=null,m)=>Ie(...E.map(f=>f(p=>c.call(u,p),null,m)))}e.any=r;function U(E,c,u,m){let f=u;return i(E,p=>(f=c(f,p),f),m)}e.reduce=U;function g(E,c){let u;const m={onWillAddFirstListener(){u=E(f.fire,f)},onDidRemoveLastListener(){u==null||u.dispose()}},f=new M(m);return c==null||c.add(f),f.event}function R(E,c,u=100,m=!1,f=!1,p,v){let y,j,Q,ce=0,z;const Un={leakWarningThreshold:p,onWillAddFirstListener(){y=E(pn=>{ce++,j=c(j,pn),m&&!Q&&(ue.fire(j),j=void 0),z=()=>{const bn=j;j=void 0,Q=void 0,(!m||ce>1)&&ue.fire(bn),ce=0},typeof u=="number"?(clearTimeout(Q),Q=setTimeout(z,u)):Q===void 0&&(Q=0,queueMicrotask(z))})},onWillRemoveListener(){f&&ce>0&&(z==null||z())},onDidRemoveLastListener(){z=void 0,y.dispose()}},ue=new M(Un);return v==null||v.add(ue),ue.event}e.debounce=R;function L(E,c=0,u){return e.debounce(E,(m,f)=>m?(m.push(f),m):[f],c,void 0,!0,void 0,u)}e.accumulate=L;function T(E,c=(m,f)=>m===f,u){let m=!0,f;return _(E,p=>{const v=m||!c(p,f);return m=!1,f=p,v},u)}e.latch=T;function A(E,c,u){return[e.filter(E,c,u),e.filter(E,m=>!c(m),u)]}e.split=A;function S(E,c=!1,u=[]){let m=u.slice(),f=E(y=>{m?m.push(y):v.fire(y)});const p=()=>{m==null||m.forEach(y=>v.fire(y)),m=null},v=new M({onWillAddFirstListener(){f||(f=E(y=>v.fire(y)))},onDidAddFirstListener(){m&&(c?setTimeout(p):p())},onDidRemoveLastListener(){f&&f.dispose(),f=null}});return v.event}e.buffer=S;class h{constructor(c){o(this,"disposables",new G);this.event=c}map(c){return new h(i(this.event,c,this.disposables))}forEach(c){return new h(s(this.event,c,this.disposables))}filter(c){return new h(_(this.event,c,this.disposables))}reduce(c,u){return new h(U(this.event,c,u,this.disposables))}latch(){return new h(T(this.event,void 0,this.disposables))}debounce(c,u=100,m=!1,f=!1,p){return new h(R(this.event,c,u,m,f,p,this.disposables))}on(c,u,m){return this.event(c,u,m)}once(c,u,m){return t(this.event)(c,u,m)}dispose(){this.disposables.dispose()}}function X(E){return new h(E)}e.chain=X;function N(E,c,u=m=>m){const m=(...y)=>v.fire(u(...y)),f=()=>E.on(c,m),p=()=>E.removeListener(c,m),v=new M({onWillAddFirstListener:f,onDidRemoveLastListener:p});return v.event}e.fromNodeEventEmitter=N;function a(E,c,u=m=>m){const m=(...y)=>v.fire(u(...y)),f=()=>E.addEventListener(c,m),p=()=>E.removeEventListener(c,m),v=new M({onWillAddFirstListener:f,onDidRemoveLastListener:p});return v.event}e.fromDOMEventEmitter=a;function D(E){return new Promise(c=>t(E)(c))}e.toPromise=D;function b(E,c){return c(void 0),E(u=>c(u))}e.runAndSubscribe=b;function d(E,c){let u=null;function m(p){u==null||u.dispose(),u=new G,c(p,u)}m(void 0);const f=E(p=>m(p));return Y(()=>{f.dispose(),u==null||u.dispose()})}e.runAndSubscribeWithStore=d})(w||(w={}));class Je{constructor(n,t=Math.random().toString(18).slice(2,5)){o(this,"_stacks");o(this,"_warnCountdown",0);this.threshold=n,this.name=t}dispose(){var n;(n=this._stacks)==null||n.clear()}check(n,t){const i=this.threshold;if(i<=0||t<i)return;this._stacks||(this._stacks=new Map);const s=this._stacks.get(n.value)||0;if(this._stacks.set(n.value,s+1),this._warnCountdown-=1,this._warnCountdown<=0){this._warnCountdown=i*.5;let _,l=0;for(const[r,U]of this._stacks)(!_||l<U)&&(_=r,l=U);console.warn(`[${this.name}] potential listener LEAK detected, having ${t} listeners already. MOST frequent listener (${l}):`),console.warn(_)}return()=>{const _=this._stacks.get(n.value)||0;this._stacks.set(n.value,_-1)}}}class ge{constructor(n){this.value=n}static create(){var n;return new ge((n=new Error().stack)!=null?n:"")}print(){console.warn(this.value.split(`
`).slice(2).join(`
`))}}class Ze{constructor(n,t,i){o(this,"subscription",new qe);this.callback=n,this.callbackThis=t,this.stack=i}invoke(n){this.callback.call(this.callbackThis,n)}}class M{constructor(n){o(this,"_options");o(this,"_leakageMon");o(this,"_perfMon");o(this,"_disposed",!1);o(this,"_event");o(this,"_deliveryQueue");o(this,"_listeners");var t,i,s,_,l;this._options=n,this._leakageMon=(t=this._options)!=null&&t.leakWarningThreshold?new Je((s=(i=this._options)==null?void 0:i.leakWarningThreshold)!=null?s:Ye):void 0,this._perfMon=(_=this._options)!=null&&_._profName?new oe(this._options._profName):void 0,this._deliveryQueue=(l=this._options)==null?void 0:l.deliveryQueue}dispose(){var n,t,i,s;this._disposed||(this._disposed=!0,this._listeners&&this._listeners.clear(),(n=this._deliveryQueue)==null||n.clear(this),(i=(t=this._options)==null?void 0:t.onDidRemoveLastListener)==null||i.call(t),(s=this._leakageMon)==null||s.dispose())}get event(){return this._event||(this._event=(n,t,i)=>{var R,L,T;if(this._listeners||(this._listeners=new me),this._leakageMon&&this._listeners.size>this._leakageMon.threshold*3)return console.warn(`[${this._leakageMon.name}] REFUSES to accept new listeners because it exceeded its threshold by far`),te.None;const s=this._listeners.isEmpty();s&&((R=this._options)==null?void 0:R.onWillAddFirstListener)&&this._options.onWillAddFirstListener(this);let _,l;this._leakageMon&&this._listeners.size>=Math.ceil(this._leakageMon.threshold*.2)&&(l=ge.create(),_=this._leakageMon.check(l,this._listeners.size+1));const r=new Ze(n,t,l),U=this._listeners.push(r);s&&((L=this._options)==null?void 0:L.onDidAddFirstListener)&&this._options.onDidAddFirstListener(this),(T=this._options)!=null&&T.onDidAddListener&&this._options.onDidAddListener(this,n,t);const g=r.subscription.set(()=>{var A,S;_==null||_(),this._disposed||((S=(A=this._options)==null?void 0:A.onWillRemoveListener)==null||S.call(A,this),U(),this._options&&this._options.onDidRemoveLastListener&&(this._listeners&&!this._listeners.isEmpty()||this._options.onDidRemoveLastListener(this)))});return i instanceof G?i.add(g):Array.isArray(i)&&i.push(g),g}),this._event}fire(n){var t,i,s;if(this._listeners){this._deliveryQueue||(this._deliveryQueue=new en((t=this._options)==null?void 0:t.onListenerError));for(const _ of this._listeners)this._deliveryQueue.push(this,_,n);(i=this._perfMon)==null||i.start(this._deliveryQueue.size),this._deliveryQueue.deliver(),(s=this._perfMon)==null||s.stop()}}hasListeners(){return this._listeners?!this._listeners.isEmpty():!1}}class Ce{constructor(n=Ve){o(this,"_queue",new me);this._onListenerError=n}get size(){return this._queue.size}push(n,t,i){this._queue.push(new nn(n,t,i))}clear(n){const t=new me;for(const i of this._queue)i.emitter!==n&&t.push(i);this._queue=t}deliver(){for(;this._queue.size>0;){const n=this._queue.shift();try{n.listener.invoke(n.event)}catch(t){this._onListenerError(t)}}}}class en extends Ce{clear(n){this._queue.clear()}}class nn{constructor(n,t,i){this.emitter=n,this.listener=t,this.event=i}}class tn{constructor(){o(this,"emitter");o(this,"hasListeners",!1);o(this,"events",[]);this.emitter=new M({onWillAddFirstListener:()=>this.onFirstListenerAdd(),onDidRemoveLastListener:()=>this.onLastListenerRemove()})}get event(){return this.emitter.event}add(n){const t={event:n,listener:null};return this.events.push(t),this.hasListeners&&this.hook(t),Y(x(()=>{this.hasListeners&&this.unhook(t);const s=this.events.indexOf(t);this.events.splice(s,1)}))}onFirstListenerAdd(){this.hasListeners=!0,this.events.forEach(n=>this.hook(n))}onLastListenerRemove(){this.hasListeners=!1,this.events.forEach(n=>this.unhook(n))}hook(n){n.listener=n.event(t=>this.emitter.fire(t))}unhook(n){n.listener&&n.listener.dispose(),n.listener=null}dispose(){this.emitter.dispose()}}class sn{constructor(){o(this,"listening",!1);o(this,"inputEvent",w.None);o(this,"inputEventListener",te.None);o(this,"emitter",new M({onDidAddFirstListener:()=>{this.listening=!0,this.inputEventListener=this.inputEvent(this.emitter.fire,this.emitter)},onDidRemoveLastListener:()=>{this.listening=!1,this.inputEventListener.dispose()}}));o(this,"event",this.emitter.event)}set input(n){this.inputEvent=n,this.listening&&(this.inputEventListener.dispose(),this.inputEventListener=n(this.emitter.fire,this.emitter))}dispose(){this.inputEventListener.dispose(),this.emitter.dispose()}}function _n(e){return e[Math.floor(Math.random()*e.length)]}const he=Object.freeze(function(e,n){const t=setTimeout(e.bind(n),0);return{dispose(){clearTimeout(t)}}});var J;(e=>{function n(t){return t===e.None||t===e.Cancelled||t instanceof le?!0:!t||typeof t!="object"?!1:typeof t.isCancellationRequested=="boolean"&&typeof t.onCancellationRequested=="function"}e.isCancellationToken=n,e.None=Object.freeze({isCancellationRequested:!1,onCancellationRequested:w.None}),e.Cancelled=Object.freeze({isCancellationRequested:!0,onCancellationRequested:he})})(J||(J={}));class le{constructor(){o(this,"_isCancelled",!1);o(this,"_emitter",null)}cancel(){this._isCancelled||(this._isCancelled=!0,this._emitter&&(this._emitter.fire(void 0),this.dispose()))}get isCancellationRequested(){return this._isCancelled}get onCancellationRequested(){return this._isCancelled?he:(this._emitter||(this._emitter=new M),this._emitter.event)}dispose(){this._emitter&&(this._emitter.dispose(),this._emitter=null)}}class Se{constructor(n){o(this,"_token");o(this,"_parentListener");this._parentListener=n&&n.onCancellationRequested(this.cancel,this)}get token(){return this._token||(this._token=new le),this._token}cancel(){this._token?this._token instanceof le&&this._token.cancel():this._token=J.Cancelled}dispose(n=!1){n&&this.cancel(),this._parentListener&&this._parentListener.dispose(),this._token?this._token instanceof le&&this._token.dispose():this._token=J.None}}function de(e){const n=new Se,t=e(n.token),i=new Promise((s,_)=>{const l=n.token.onCancellationRequested(()=>{l.dispose(),n.dispose(),_(new V)});Promise.resolve(t).then(r=>{l.dispose(),n.dispose(),s(r)},r=>{l.dispose(),n.dispose(),_(r)})});return new class{cancel(){n.cancel()}then(s,_){return i.then(s,_)}catch(s){return this.then(void 0,s)}finally(s){return i.finally(s)}}}(function(){(typeof requestIdleCallback!="function"||typeof cancelIdleCallback!="function")&&Object.freeze({didTimeout:!0,timeRemaining(){return 15}})})();var ye;(e=>{async function n(i){let s;const _=await Promise.all(i.map(l=>l.then(r=>r,r=>{s||(s=r)})));if(typeof s<"u")throw s;return _}e.settled=n;function t(i){return new Promise(async(s,_)=>{try{await i(s,_)}catch(l){_(l)}})}e.withAsyncBody=t})(ye||(ye={}));function on(e,n,t){let i=null,s=null;if(typeof t.value=="function"?(i="value",s=t.value,s.length!==0&&console.warn("Memoize should only be used in functions with zero parameters")):typeof t.get=="function"&&(i="get",s=t.get),!s)throw new Error("not supported");const _=`$memoize$${n}`;t[i]=function(...l){return this.hasOwnProperty(_)||Object.defineProperty(this,_,{configurable:!1,enumerable:!1,writable:!1,value:s.apply(this,l)}),this[_]}}function Ne(...e){throw e.length&&console.error(...e),new Error("not reached")}function Be(...e){throw e.length&&console.error(...e),new Error("not implemented")}var Re=(e=>(e[e.Null=0]="Null",e[e.Backspace=8]="Backspace",e[e.Tab=9]="Tab",e[e.LineFeed=10]="LineFeed",e[e.CarriageReturn=13]="CarriageReturn",e[e.Space=32]="Space",e[e.ExclamationMark=33]="ExclamationMark",e[e.DoubleQuote=34]="DoubleQuote",e[e.Hash=35]="Hash",e[e.DollarSign=36]="DollarSign",e[e.PercentSign=37]="PercentSign",e[e.Ampersand=38]="Ampersand",e[e.SingleQuote=39]="SingleQuote",e[e.OpenParen=40]="OpenParen",e[e.CloseParen=41]="CloseParen",e[e.Asterisk=42]="Asterisk",e[e.Plus=43]="Plus",e[e.Comma=44]="Comma",e[e.Dash=45]="Dash",e[e.Period=46]="Period",e[e.Slash=47]="Slash",e[e.Digit0=48]="Digit0",e[e.Digit1=49]="Digit1",e[e.Digit2=50]="Digit2",e[e.Digit3=51]="Digit3",e[e.Digit4=52]="Digit4",e[e.Digit5=53]="Digit5",e[e.Digit6=54]="Digit6",e[e.Digit7=55]="Digit7",e[e.Digit8=56]="Digit8",e[e.Digit9=57]="Digit9",e[e.Colon=58]="Colon",e[e.Semicolon=59]="Semicolon",e[e.LessThan=60]="LessThan",e[e.Equals=61]="Equals",e[e.GreaterThan=62]="GreaterThan",e[e.QuestionMark=63]="QuestionMark",e[e.AtSign=64]="AtSign",e[e.A=65]="A",e[e.B=66]="B",e[e.C=67]="C",e[e.D=68]="D",e[e.E=69]="E",e[e.F=70]="F",e[e.G=71]="G",e[e.H=72]="H",e[e.I=73]="I",e[e.J=74]="J",e[e.K=75]="K",e[e.L=76]="L",e[e.M=77]="M",e[e.N=78]="N",e[e.O=79]="O",e[e.P=80]="P",e[e.Q=81]="Q",e[e.R=82]="R",e[e.S=83]="S",e[e.T=84]="T",e[e.U=85]="U",e[e.V=86]="V",e[e.W=87]="W",e[e.X=88]="X",e[e.Y=89]="Y",e[e.Z=90]="Z",e[e.OpenSquareBracket=91]="OpenSquareBracket",e[e.Backslash=92]="Backslash",e[e.CloseSquareBracket=93]="CloseSquareBracket",e[e.Caret=94]="Caret",e[e.Underline=95]="Underline",e[e.BackTick=96]="BackTick",e[e.a=97]="a",e[e.b=98]="b",e[e.c=99]="c",e[e.d=100]="d",e[e.e=101]="e",e[e.f=102]="f",e[e.g=103]="g",e[e.h=104]="h",e[e.i=105]="i",e[e.j=106]="j",e[e.k=107]="k",e[e.l=108]="l",e[e.m=109]="m",e[e.n=110]="n",e[e.o=111]="o",e[e.p=112]="p",e[e.q=113]="q",e[e.r=114]="r",e[e.s=115]="s",e[e.t=116]="t",e[e.u=117]="u",e[e.v=118]="v",e[e.w=119]="w",e[e.x=120]="x",e[e.y=121]="y",e[e.z=122]="z",e[e.OpenCurlyBrace=123]="OpenCurlyBrace",e[e.Pipe=124]="Pipe",e[e.CloseCurlyBrace=125]="CloseCurlyBrace",e[e.Tilde=126]="Tilde",e[e.U_Combining_Grave_Accent=768]="U_Combining_Grave_Accent",e[e.U_Combining_Acute_Accent=769]="U_Combining_Acute_Accent",e[e.U_Combining_Circumflex_Accent=770]="U_Combining_Circumflex_Accent",e[e.U_Combining_Tilde=771]="U_Combining_Tilde",e[e.U_Combining_Macron=772]="U_Combining_Macron",e[e.U_Combining_Overline=773]="U_Combining_Overline",e[e.U_Combining_Breve=774]="U_Combining_Breve",e[e.U_Combining_Dot_Above=775]="U_Combining_Dot_Above",e[e.U_Combining_Diaeresis=776]="U_Combining_Diaeresis",e[e.U_Combining_Hook_Above=777]="U_Combining_Hook_Above",e[e.U_Combining_Ring_Above=778]="U_Combining_Ring_Above",e[e.U_Combining_Double_Acute_Accent=779]="U_Combining_Double_Acute_Accent",e[e.U_Combining_Caron=780]="U_Combining_Caron",e[e.U_Combining_Vertical_Line_Above=781]="U_Combining_Vertical_Line_Above",e[e.U_Combining_Double_Vertical_Line_Above=782]="U_Combining_Double_Vertical_Line_Above",e[e.U_Combining_Double_Grave_Accent=783]="U_Combining_Double_Grave_Accent",e[e.U_Combining_Candrabindu=784]="U_Combining_Candrabindu",e[e.U_Combining_Inverted_Breve=785]="U_Combining_Inverted_Breve",e[e.U_Combining_Turned_Comma_Above=786]="U_Combining_Turned_Comma_Above",e[e.U_Combining_Comma_Above=787]="U_Combining_Comma_Above",e[e.U_Combining_Reversed_Comma_Above=788]="U_Combining_Reversed_Comma_Above",e[e.U_Combining_Comma_Above_Right=789]="U_Combining_Comma_Above_Right",e[e.U_Combining_Grave_Accent_Below=790]="U_Combining_Grave_Accent_Below",e[e.U_Combining_Acute_Accent_Below=791]="U_Combining_Acute_Accent_Below",e[e.U_Combining_Left_Tack_Below=792]="U_Combining_Left_Tack_Below",e[e.U_Combining_Right_Tack_Below=793]="U_Combining_Right_Tack_Below",e[e.U_Combining_Left_Angle_Above=794]="U_Combining_Left_Angle_Above",e[e.U_Combining_Horn=795]="U_Combining_Horn",e[e.U_Combining_Left_Half_Ring_Below=796]="U_Combining_Left_Half_Ring_Below",e[e.U_Combining_Up_Tack_Below=797]="U_Combining_Up_Tack_Below",e[e.U_Combining_Down_Tack_Below=798]="U_Combining_Down_Tack_Below",e[e.U_Combining_Plus_Sign_Below=799]="U_Combining_Plus_Sign_Below",e[e.U_Combining_Minus_Sign_Below=800]="U_Combining_Minus_Sign_Below",e[e.U_Combining_Palatalized_Hook_Below=801]="U_Combining_Palatalized_Hook_Below",e[e.U_Combining_Retroflex_Hook_Below=802]="U_Combining_Retroflex_Hook_Below",e[e.U_Combining_Dot_Below=803]="U_Combining_Dot_Below",e[e.U_Combining_Diaeresis_Below=804]="U_Combining_Diaeresis_Below",e[e.U_Combining_Ring_Below=805]="U_Combining_Ring_Below",e[e.U_Combining_Comma_Below=806]="U_Combining_Comma_Below",e[e.U_Combining_Cedilla=807]="U_Combining_Cedilla",e[e.U_Combining_Ogonek=808]="U_Combining_Ogonek",e[e.U_Combining_Vertical_Line_Below=809]="U_Combining_Vertical_Line_Below",e[e.U_Combining_Bridge_Below=810]="U_Combining_Bridge_Below",e[e.U_Combining_Inverted_Double_Arch_Below=811]="U_Combining_Inverted_Double_Arch_Below",e[e.U_Combining_Caron_Below=812]="U_Combining_Caron_Below",e[e.U_Combining_Circumflex_Accent_Below=813]="U_Combining_Circumflex_Accent_Below",e[e.U_Combining_Breve_Below=814]="U_Combining_Breve_Below",e[e.U_Combining_Inverted_Breve_Below=815]="U_Combining_Inverted_Breve_Below",e[e.U_Combining_Tilde_Below=816]="U_Combining_Tilde_Below",e[e.U_Combining_Macron_Below=817]="U_Combining_Macron_Below",e[e.U_Combining_Low_Line=818]="U_Combining_Low_Line",e[e.U_Combining_Double_Low_Line=819]="U_Combining_Double_Low_Line",e[e.U_Combining_Tilde_Overlay=820]="U_Combining_Tilde_Overlay",e[e.U_Combining_Short_Stroke_Overlay=821]="U_Combining_Short_Stroke_Overlay",e[e.U_Combining_Long_Stroke_Overlay=822]="U_Combining_Long_Stroke_Overlay",e[e.U_Combining_Short_Solidus_Overlay=823]="U_Combining_Short_Solidus_Overlay",e[e.U_Combining_Long_Solidus_Overlay=824]="U_Combining_Long_Solidus_Overlay",e[e.U_Combining_Right_Half_Ring_Below=825]="U_Combining_Right_Half_Ring_Below",e[e.U_Combining_Inverted_Bridge_Below=826]="U_Combining_Inverted_Bridge_Below",e[e.U_Combining_Square_Below=827]="U_Combining_Square_Below",e[e.U_Combining_Seagull_Below=828]="U_Combining_Seagull_Below",e[e.U_Combining_X_Above=829]="U_Combining_X_Above",e[e.U_Combining_Vertical_Tilde=830]="U_Combining_Vertical_Tilde",e[e.U_Combining_Double_Overline=831]="U_Combining_Double_Overline",e[e.U_Combining_Grave_Tone_Mark=832]="U_Combining_Grave_Tone_Mark",e[e.U_Combining_Acute_Tone_Mark=833]="U_Combining_Acute_Tone_Mark",e[e.U_Combining_Greek_Perispomeni=834]="U_Combining_Greek_Perispomeni",e[e.U_Combining_Greek_Koronis=835]="U_Combining_Greek_Koronis",e[e.U_Combining_Greek_Dialytika_Tonos=836]="U_Combining_Greek_Dialytika_Tonos",e[e.U_Combining_Greek_Ypogegrammeni=837]="U_Combining_Greek_Ypogegrammeni",e[e.U_Combining_Bridge_Above=838]="U_Combining_Bridge_Above",e[e.U_Combining_Equals_Sign_Below=839]="U_Combining_Equals_Sign_Below",e[e.U_Combining_Double_Vertical_Line_Below=840]="U_Combining_Double_Vertical_Line_Below",e[e.U_Combining_Left_Angle_Below=841]="U_Combining_Left_Angle_Below",e[e.U_Combining_Not_Tilde_Above=842]="U_Combining_Not_Tilde_Above",e[e.U_Combining_Homothetic_Above=843]="U_Combining_Homothetic_Above",e[e.U_Combining_Almost_Equal_To_Above=844]="U_Combining_Almost_Equal_To_Above",e[e.U_Combining_Left_Right_Arrow_Below=845]="U_Combining_Left_Right_Arrow_Below",e[e.U_Combining_Upwards_Arrow_Below=846]="U_Combining_Upwards_Arrow_Below",e[e.U_Combining_Grapheme_Joiner=847]="U_Combining_Grapheme_Joiner",e[e.U_Combining_Right_Arrowhead_Above=848]="U_Combining_Right_Arrowhead_Above",e[e.U_Combining_Left_Half_Ring_Above=849]="U_Combining_Left_Half_Ring_Above",e[e.U_Combining_Fermata=850]="U_Combining_Fermata",e[e.U_Combining_X_Below=851]="U_Combining_X_Below",e[e.U_Combining_Left_Arrowhead_Below=852]="U_Combining_Left_Arrowhead_Below",e[e.U_Combining_Right_Arrowhead_Below=853]="U_Combining_Right_Arrowhead_Below",e[e.U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below=854]="U_Combining_Right_Arrowhead_And_Up_Arrowhead_Below",e[e.U_Combining_Right_Half_Ring_Above=855]="U_Combining_Right_Half_Ring_Above",e[e.U_Combining_Dot_Above_Right=856]="U_Combining_Dot_Above_Right",e[e.U_Combining_Asterisk_Below=857]="U_Combining_Asterisk_Below",e[e.U_Combining_Double_Ring_Below=858]="U_Combining_Double_Ring_Below",e[e.U_Combining_Zigzag_Above=859]="U_Combining_Zigzag_Above",e[e.U_Combining_Double_Breve_Below=860]="U_Combining_Double_Breve_Below",e[e.U_Combining_Double_Breve=861]="U_Combining_Double_Breve",e[e.U_Combining_Double_Macron=862]="U_Combining_Double_Macron",e[e.U_Combining_Double_Macron_Below=863]="U_Combining_Double_Macron_Below",e[e.U_Combining_Double_Tilde=864]="U_Combining_Double_Tilde",e[e.U_Combining_Double_Inverted_Breve=865]="U_Combining_Double_Inverted_Breve",e[e.U_Combining_Double_Rightwards_Arrow_Below=866]="U_Combining_Double_Rightwards_Arrow_Below",e[e.U_Combining_Latin_Small_Letter_A=867]="U_Combining_Latin_Small_Letter_A",e[e.U_Combining_Latin_Small_Letter_E=868]="U_Combining_Latin_Small_Letter_E",e[e.U_Combining_Latin_Small_Letter_I=869]="U_Combining_Latin_Small_Letter_I",e[e.U_Combining_Latin_Small_Letter_O=870]="U_Combining_Latin_Small_Letter_O",e[e.U_Combining_Latin_Small_Letter_U=871]="U_Combining_Latin_Small_Letter_U",e[e.U_Combining_Latin_Small_Letter_C=872]="U_Combining_Latin_Small_Letter_C",e[e.U_Combining_Latin_Small_Letter_D=873]="U_Combining_Latin_Small_Letter_D",e[e.U_Combining_Latin_Small_Letter_H=874]="U_Combining_Latin_Small_Letter_H",e[e.U_Combining_Latin_Small_Letter_M=875]="U_Combining_Latin_Small_Letter_M",e[e.U_Combining_Latin_Small_Letter_R=876]="U_Combining_Latin_Small_Letter_R",e[e.U_Combining_Latin_Small_Letter_T=877]="U_Combining_Latin_Small_Letter_T",e[e.U_Combining_Latin_Small_Letter_V=878]="U_Combining_Latin_Small_Letter_V",e[e.U_Combining_Latin_Small_Letter_X=879]="U_Combining_Latin_Small_Letter_X",e[e.LINE_SEPARATOR=8232]="LINE_SEPARATOR",e[e.PARAGRAPH_SEPARATOR=8233]="PARAGRAPH_SEPARATOR",e[e.NEXT_LINE=133]="NEXT_LINE",e[e.U_CIRCUMFLEX=94]="U_CIRCUMFLEX",e[e.U_GRAVE_ACCENT=96]="U_GRAVE_ACCENT",e[e.U_DIAERESIS=168]="U_DIAERESIS",e[e.U_MACRON=175]="U_MACRON",e[e.U_ACUTE_ACCENT=180]="U_ACUTE_ACCENT",e[e.U_CEDILLA=184]="U_CEDILLA",e[e.U_MODIFIER_LETTER_LEFT_ARROWHEAD=706]="U_MODIFIER_LETTER_LEFT_ARROWHEAD",e[e.U_MODIFIER_LETTER_RIGHT_ARROWHEAD=707]="U_MODIFIER_LETTER_RIGHT_ARROWHEAD",e[e.U_MODIFIER_LETTER_UP_ARROWHEAD=708]="U_MODIFIER_LETTER_UP_ARROWHEAD",e[e.U_MODIFIER_LETTER_DOWN_ARROWHEAD=709]="U_MODIFIER_LETTER_DOWN_ARROWHEAD",e[e.U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING=722]="U_MODIFIER_LETTER_CENTRED_RIGHT_HALF_RING",e[e.U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING=723]="U_MODIFIER_LETTER_CENTRED_LEFT_HALF_RING",e[e.U_MODIFIER_LETTER_UP_TACK=724]="U_MODIFIER_LETTER_UP_TACK",e[e.U_MODIFIER_LETTER_DOWN_TACK=725]="U_MODIFIER_LETTER_DOWN_TACK",e[e.U_MODIFIER_LETTER_PLUS_SIGN=726]="U_MODIFIER_LETTER_PLUS_SIGN",e[e.U_MODIFIER_LETTER_MINUS_SIGN=727]="U_MODIFIER_LETTER_MINUS_SIGN",e[e.U_BREVE=728]="U_BREVE",e[e.U_DOT_ABOVE=729]="U_DOT_ABOVE",e[e.U_RING_ABOVE=730]="U_RING_ABOVE",e[e.U_OGONEK=731]="U_OGONEK",e[e.U_SMALL_TILDE=732]="U_SMALL_TILDE",e[e.U_DOUBLE_ACUTE_ACCENT=733]="U_DOUBLE_ACUTE_ACCENT",e[e.U_MODIFIER_LETTER_RHOTIC_HOOK=734]="U_MODIFIER_LETTER_RHOTIC_HOOK",e[e.U_MODIFIER_LETTER_CROSS_ACCENT=735]="U_MODIFIER_LETTER_CROSS_ACCENT",e[e.U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR=741]="U_MODIFIER_LETTER_EXTRA_HIGH_TONE_BAR",e[e.U_MODIFIER_LETTER_HIGH_TONE_BAR=742]="U_MODIFIER_LETTER_HIGH_TONE_BAR",e[e.U_MODIFIER_LETTER_MID_TONE_BAR=743]="U_MODIFIER_LETTER_MID_TONE_BAR",e[e.U_MODIFIER_LETTER_LOW_TONE_BAR=744]="U_MODIFIER_LETTER_LOW_TONE_BAR",e[e.U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR=745]="U_MODIFIER_LETTER_EXTRA_LOW_TONE_BAR",e[e.U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK=746]="U_MODIFIER_LETTER_YIN_DEPARTING_TONE_MARK",e[e.U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK=747]="U_MODIFIER_LETTER_YANG_DEPARTING_TONE_MARK",e[e.U_MODIFIER_LETTER_UNASPIRATED=749]="U_MODIFIER_LETTER_UNASPIRATED",e[e.U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD=751]="U_MODIFIER_LETTER_LOW_DOWN_ARROWHEAD",e[e.U_MODIFIER_LETTER_LOW_UP_ARROWHEAD=752]="U_MODIFIER_LETTER_LOW_UP_ARROWHEAD",e[e.U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD=753]="U_MODIFIER_LETTER_LOW_LEFT_ARROWHEAD",e[e.U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD=754]="U_MODIFIER_LETTER_LOW_RIGHT_ARROWHEAD",e[e.U_MODIFIER_LETTER_LOW_RING=755]="U_MODIFIER_LETTER_LOW_RING",e[e.U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT=756]="U_MODIFIER_LETTER_MIDDLE_GRAVE_ACCENT",e[e.U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT=757]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_GRAVE_ACCENT",e[e.U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT=758]="U_MODIFIER_LETTER_MIDDLE_DOUBLE_ACUTE_ACCENT",e[e.U_MODIFIER_LETTER_LOW_TILDE=759]="U_MODIFIER_LETTER_LOW_TILDE",e[e.U_MODIFIER_LETTER_RAISED_COLON=760]="U_MODIFIER_LETTER_RAISED_COLON",e[e.U_MODIFIER_LETTER_BEGIN_HIGH_TONE=761]="U_MODIFIER_LETTER_BEGIN_HIGH_TONE",e[e.U_MODIFIER_LETTER_END_HIGH_TONE=762]="U_MODIFIER_LETTER_END_HIGH_TONE",e[e.U_MODIFIER_LETTER_BEGIN_LOW_TONE=763]="U_MODIFIER_LETTER_BEGIN_LOW_TONE",e[e.U_MODIFIER_LETTER_END_LOW_TONE=764]="U_MODIFIER_LETTER_END_LOW_TONE",e[e.U_MODIFIER_LETTER_SHELF=765]="U_MODIFIER_LETTER_SHELF",e[e.U_MODIFIER_LETTER_OPEN_SHELF=766]="U_MODIFIER_LETTER_OPEN_SHELF",e[e.U_MODIFIER_LETTER_LOW_LEFT_ARROW=767]="U_MODIFIER_LETTER_LOW_LEFT_ARROW",e[e.U_GREEK_LOWER_NUMERAL_SIGN=885]="U_GREEK_LOWER_NUMERAL_SIGN",e[e.U_GREEK_TONOS=900]="U_GREEK_TONOS",e[e.U_GREEK_DIALYTIKA_TONOS=901]="U_GREEK_DIALYTIKA_TONOS",e[e.U_GREEK_KORONIS=8125]="U_GREEK_KORONIS",e[e.U_GREEK_PSILI=8127]="U_GREEK_PSILI",e[e.U_GREEK_PERISPOMENI=8128]="U_GREEK_PERISPOMENI",e[e.U_GREEK_DIALYTIKA_AND_PERISPOMENI=8129]="U_GREEK_DIALYTIKA_AND_PERISPOMENI",e[e.U_GREEK_PSILI_AND_VARIA=8141]="U_GREEK_PSILI_AND_VARIA",e[e.U_GREEK_PSILI_AND_OXIA=8142]="U_GREEK_PSILI_AND_OXIA",e[e.U_GREEK_PSILI_AND_PERISPOMENI=8143]="U_GREEK_PSILI_AND_PERISPOMENI",e[e.U_GREEK_DASIA_AND_VARIA=8157]="U_GREEK_DASIA_AND_VARIA",e[e.U_GREEK_DASIA_AND_OXIA=8158]="U_GREEK_DASIA_AND_OXIA",e[e.U_GREEK_DASIA_AND_PERISPOMENI=8159]="U_GREEK_DASIA_AND_PERISPOMENI",e[e.U_GREEK_DIALYTIKA_AND_VARIA=8173]="U_GREEK_DIALYTIKA_AND_VARIA",e[e.U_GREEK_DIALYTIKA_AND_OXIA=8174]="U_GREEK_DIALYTIKA_AND_OXIA",e[e.U_GREEK_VARIA=8175]="U_GREEK_VARIA",e[e.U_GREEK_OXIA=8189]="U_GREEK_OXIA",e[e.U_GREEK_DASIA=8190]="U_GREEK_DASIA",e[e.U_OVERLINE=8254]="U_OVERLINE",e[e.UTF8_BOM=65279]="UTF8_BOM",e))(Re||{});function ke(e){return e>=Re.A&&e<=Re.Z}var ln=Object.defineProperty,rn=Object.getOwnPropertyDescriptor,cn=(e,n,t,i)=>{for(var s=i>1?void 0:i?rn(n,t):n,_=e.length-1,l;_>=0;_--)(l=e[_])&&(s=(i?l(n,t,s):l(s))||s);return i&&s&&ln(n,t,s),s};function $(e){switch(e){case 100:return"req";case 101:return"cancel";case 102:return"subscribe";case 103:return"unsubscribe"}}function re(e){switch(e){case 200:return"init";case 201:return"reply:";case 202:case 203:return"replyErr:";case 204:return"event:"}}class Pe{constructor(n,t,i=null,s=1e3){o(this,"channels",new Map);o(this,"activeRequests",new Map);o(this,"protocolListener");o(this,"pendingRequests",new Map);this.protocol=n,this.ctx=t,this.logger=i,this.timeoutDelay=s,this.protocolListener=this.protocol.onMessage(_=>this.onRawMessage(_)),this.sendResponse({type:200})}registerChannel(n,t){this.channels.set(n,t),setTimeout(()=>this.flushPendingRequests(n),0)}sendResponse(n){var t,i;switch(n.type){case 200:{this.send([n.type]),(t=this.logger)==null||t.logOutgoing(0,K.OtherSide,re(n.type));return}case 201:case 202:case 204:case 203:{this.send([n.type,n.id],n.data),(i=this.logger)==null||i.logOutgoing(n.id,K.OtherSide,re(n.type),n.data);return}}}send(n,t){try{return this.protocol.send({head:n,body:t}),1}catch{return 0}}onRawMessage(n){var _,l,r,U;const t=n.head,i=n.body,s=t[0];switch(s){case 100:return(_=this.logger)==null||_.logIncoming(t[1],K.OtherSide,`${$(s)}: ${t[2]}.${t[3]}`,i),this.onPromise({type:s,id:t[1],channelName:t[2],name:t[3],arg:i});case 102:return(l=this.logger)==null||l.logIncoming(t[1],K.OtherSide,`${$(s)}: ${t[2]}.${t[3]}`,i),this.onEventListen({type:s,id:t[1],channelName:t[2],name:t[3],arg:i});case 101:return(r=this.logger)==null||r.logIncoming(t[1],K.OtherSide,`${$(s)}`),this.disposeActiveRequest({type:s,id:t[1]});case 103:return(U=this.logger)==null||U.logIncoming(t[1],K.OtherSide,`${$(s)}`),this.disposeActiveRequest({type:s,id:t[1]})}}onPromise(n){const t=this.channels.get(n.channelName);if(!t){this.collectPendingRequest(n);return}const i=new Se;let s;try{s=t.call(this.ctx,n.name,n.arg,i.token)}catch(r){s=Promise.reject(r)}const _=n.id;s.then(r=>{this.sendResponse({id:_,data:r,type:201}),this.activeRequests.delete(n.id)},r=>{r instanceof Error?this.sendResponse({id:_,data:{message:r.message,name:r.name,stack:r.stack?r.stack.split?r.stack.split(`
`):r.stack:void 0},type:202}):this.sendResponse({id:_,data:r,type:203}),this.activeRequests.delete(n.id)});const l=Y(()=>i.cancel());this.activeRequests.set(n.id,l)}onEventListen(n){const t=this.channels.get(n.channelName);if(!t){this.collectPendingRequest(n);return}const i=n.id,_=t.listen(this.ctx,n.name,n.arg)(l=>this.sendResponse({id:i,data:l,type:204}));this.activeRequests.set(n.id,_)}disposeActiveRequest(n){const t=this.activeRequests.get(n.id);t&&(t.dispose(),this.activeRequests.delete(n.id))}collectPendingRequest(n){let t=this.pendingRequests.get(n.channelName);t||(t=[],this.pendingRequests.set(n.channelName,t));const i=setTimeout(()=>{console.error(`Unknown channel: ${n.channelName}`),n.type===100&&this.sendResponse({id:n.id,data:{name:"Unknown channel",message:`Channel name '${n.channelName}' timed out after ${this.timeoutDelay}ms`,stack:void 0},type:202})},this.timeoutDelay);t.push({request:n,timeoutTimer:i})}flushPendingRequests(n){const t=this.pendingRequests.get(n);if(t){for(const i of t)switch(clearTimeout(i.timeoutTimer),i.request.type){case 100:this.onPromise(i.request);break;case 102:this.onEventListen(i.request);break}this.pendingRequests.delete(n)}}dispose(){this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),ne(this.activeRequests.values()),this.activeRequests.clear()}}var K=(e=>(e[e.LocalSide=0]="LocalSide",e[e.OtherSide=1]="OtherSide",e))(K||{});class Ue{constructor(n,t=null){o(this,"isDisposed",!1);o(this,"state",0);o(this,"activeRequests",new Set);o(this,"handlers",new Map);o(this,"lastRequestId",0);o(this,"protocolListener");o(this,"logger");o(this,"_onDidInitialize",new M);o(this,"onDidInitialize",this._onDidInitialize.event);this.protocol=n,this.protocolListener=this.protocol.onMessage(i=>this.onMessage(i)),this.logger=t}getChannel(n){const t=this;return{call(i,s,_){return t.isDisposed?Promise.reject(new V):t.requestPromise(n,i,s,_)},listen(i,s){return t.isDisposed?w.None:t.requestEvent(n,i,s)}}}requestPromise(n,t,i,s=J.None){const _=this.lastRequestId++,r={id:_,type:100,channelName:n,name:t,arg:i};if(s.isCancellationRequested)return Promise.reject(new V);let U;return new Promise((R,L)=>{if(s.isCancellationRequested)return L(new V);const T=()=>{const X=N=>{switch(N.type){case 201:this.handlers.delete(_),R(N.data);break;case 202:{this.handlers.delete(_);const a=new Error(N.data.message);a.stack=Array.isArray(N.data.stack)?N.data.stack.join(`
`):N.data.stack,a.name=N.data.name,L(a);break}case 203:this.handlers.delete(_),L(N.data);break}};this.handlers.set(_,X),this.sendRequest(r)};let A=null;this.state===1?T():(A=de(X=>this.whenInitialized()),A.then(()=>{A=null,T()}));const S=()=>{A?(A.cancel(),A=null):this.sendRequest({id:_,type:101}),L(new V)},h=s.onCancellationRequested(S);U=Ie(Y(S),h),this.activeRequests.add(U)}).finally(()=>{this.activeRequests.delete(U)})}requestEvent(n,t,i){const s=this.lastRequestId++,l={id:s,type:102,channelName:n,name:t,arg:i};let r=null;const U=new M({onWillAddFirstListener:()=>{r=de(R=>this.whenInitialized()),r.then(()=>{r=null,this.activeRequests.add(U),this.sendRequest(l)})},onDidRemoveLastListener:()=>{r?(r.cancel(),r=null):(this.activeRequests.delete(U),this.sendRequest({id:s,type:103}))}}),g=R=>U.fire(R.data);return this.handlers.set(s,g),U.event}sendRequest(n){var t,i;switch(n.type){case 100:case 102:{this.send([n.type,n.id,n.channelName,n.name],n.arg),(t=this.logger)==null||t.logOutgoing(n.id,0,`${$(n.type)}: ${n.channelName}.${n.name}`,n.arg);return}case 101:case 103:{this.send([n.type,n.id]),(i=this.logger)==null||i.logOutgoing(n.id,0,$(n.type));return}}}send(n,t){try{return this.protocol.send({head:n,body:t}),1}catch{return 0}}onMessage(n){var _,l;const t=n.head,i=n.body,s=t[0];switch(s){case 200:return(_=this.logger)==null||_.logIncoming(0,0,re(s)),this.onResponse({type:t[0]});case 201:case 202:case 204:case 203:return(l=this.logger)==null||l.logIncoming(t[1],0,re(s),i),this.onResponse({type:t[0],id:t[1],data:i})}}onResponse(n){if(n.type===200){this.state=1,this._onDidInitialize.fire();return}const t=this.handlers.get(n.id);t==null||t(n)}get onDidInitializePromise(){return w.toPromise(this.onDidInitialize)}whenInitialized(){return this.state===1?Promise.resolve():this.onDidInitializePromise}dispose(){this.isDisposed=!0,this.protocolListener&&(this.protocolListener.dispose(),this.protocolListener=null),ne(this.activeRequests.values()),this.activeRequests.clear()}}cn([on],Ue.prototype,"onDidInitializePromise",1);class un{constructor(n){o(this,"channels",new Map);o(this,"_connections",new Set);o(this,"_onDidAddConnection",new M);o(this,"onDidAddConnection",this._onDidAddConnection.event);o(this,"_onDidRemoveConnection",new M);o(this,"onDidRemoveConnection",this._onDidRemoveConnection.event);n(({protocol:t,onDidClientDisconnect:i})=>{w.once(t.onMessage)(_=>{const l=_,r=new Pe(t,l),U=new Ue(t);this.channels.forEach((R,L)=>r.registerChannel(L,R));const g={channelServer:r,channelClient:U,ctx:l};this._connections.add(g),this._onDidAddConnection.fire(g),i(()=>{r.dispose(),U.dispose(),this._connections.delete(g),this._onDidRemoveConnection.fire(g)})})})}get connections(){const n=[];return this._connections.forEach(t=>n.push(t)),n}getChannel(n,t){const i=this;return{call(s,_,l){let r;if(ve(t)){const g=_n(i.connections.filter(t));r=g?Promise.resolve(g):w.toPromise(w.filter(i.onDidAddConnection,t))}else r=t.routeCall(i,s,_);const U=r.then(g=>g.channelClient.getChannel(n));return pe(U).call(s,_,l)},listen(s,_){if(ve(t))return i.getMulticastEvent(n,t,s,_);const l=t.routeEvent(i,s,_).then(r=>r.channelClient.getChannel(n));return pe(l).listen(s,_)}}}getMulticastEvent(n,t,i,s){const _=this;let l=new G;const r=new M({onWillAddFirstListener:()=>{l=new G;const U=new tn,g=new Map,R=T=>{const S=T.channelClient.getChannel(n).listen(i,s),h=U.add(S);g.set(T,h)},L=T=>{const A=g.get(T);!A||(A.dispose(),g.delete(T))};_.connections.filter(t).forEach(R),w.filter(_.onDidAddConnection,t)(R,void 0,l),_.onDidRemoveConnection(L,void 0,l),U.event(r.fire,r,l),l.add(U)},onDidRemoveLastListener:()=>{l.dispose()}});return r.event}registerChannel(n,t){this.channels.set(n,t),this._connections.forEach(i=>{i.channelServer.registerChannel(n,t)})}dispose(){this.channels.clear(),this._connections.clear(),this._onDidAddConnection.dispose(),this._onDidRemoveConnection.dispose()}}class mn{constructor(n,t,i=null){o(this,"channelClient");o(this,"channelServer");this.channelClient=new Ue(n,i),this.channelServer=new Pe(n,t,i)}getChannel(n){return this.channelClient.getChannel(n)}registerChannel(n,t){this.channelServer.registerChannel(n,t)}dispose(){this.channelClient.dispose(),this.channelServer.dispose()}}function pe(e){return{call(n,t,i){return e.then(s=>s.call(n,t,i))},listen(n,t){const i=new sn;return e.then(s=>i.input=s.listen(n,t)),i.event}}}var Fe;(e=>{function n(_,l){const r=_,U=l&&l.disableMarshalling,g=new Map;for(const R in r)i(R)&&g.set(R,w.buffer(r[R],!0));return new class{listen(R,L,T){const A=g.get(L);if(A)return A;if(s(L)){const S=r[L];if(typeof S=="function")return S.call(r,T)}throw new Error(`Event not found: ${L}`)}call(R,L,T){const A=r[L];if(typeof A=="function")return!U&&Array.isArray(T)&&Ne(),A.apply(r,T);throw new Error(`Method not found: ${L}`)}}}e.fromService=n;function t(_,l){const r=l&&l.disableMarshalling;return new Proxy({},{get(U,g){var R;if(typeof g=="string")return(R=l==null?void 0:l.properties)!=null&&R.has(g)?l.properties.get(g):s(g)?function(L){return _.listen(g,L)}:i(g)?_.listen(g):async function(...L){let T;l&&!He(l.context)?T=[l.context,...L]:T=L;const A=await _.call(g,T);return r||Ne(),A};throw new Error(`Property not found: ${String(g)}`)}})}e.toService=t;function i(_){return _[0]==="o"&&_[1]==="n"&&ke(_.charCodeAt(2))}function s(_){return/^onDynamic/.test(_)&&ke(_.charCodeAt(9))}})(Fe||(Fe={}));class Ge{constructor(n){o(this,"onMessage");this.port=n,n.start(),this.onMessage=w.fromDOMEventEmitter(this.port,"message",t=>t.data)}send(n){this.port.postMessage(n)}disconnect(){this.port.close()}}class En extends mn{constructor(t,i){const s=new Ge(t);super(s,i);o(this,"protocol");this.protocol=s}dispose(){this.protocol.disconnect()}}class an extends En{constructor(n,t){super(n,t)}}var be=(e=>(e.createMessageChannel="createMessageChannel",e.createMessageChannelResult="createMessageChannelResult",e.transferMessageChannelResult="transferMessageChannelResult",e))(be||{});class Le extends un{static getOnDidClientConnect(){const n=w.fromDOMEventEmitter(self,"message",t=>t.data);return w.map(w.filter(n,t=>!!t&&t.command==="createMessageChannel"),t=>{const{port1:i,port2:s}=new MessageChannel,l={protocol:new Ge(i),onDidClientDisconnect:w.fromDOMEventEmitter(i,"close")};return self.postMessage({command:"createMessageChannelResult",arg:t.arg},{transfer:[s]}),l})}constructor(){super(Le.getOnDidClientConnect())}}class fn{constructor(){o(this,"_onUpdate",new M);o(this,"_onTick",new M);o(this,"_particles",[])}get onUpdate(){return this._onUpdate.event}get onTick(){return this._onTick.event}echo(){return"hello model!"}load(n){const{w:t,h:i}=n,s=[],_=2,l=["#f35d4f","#f36849","#c0d988","#6ddaf1","#f1e85b"];for(var r=0;r<_;r++)s.push({x:Math.round(Math.random()*t),y:Math.round(Math.random()*i),rad:Math.round(Math.random())+1,rgba:l[Math.round(Math.random()*3)],vx:Math.round(Math.random()*3)-1.5,vy:Math.round(Math.random()*3)-1.5});this._particles=s,this._onUpdate.fire();const U=()=>{for(let g=0;g<_;g++){let R=s[g];R.x+=R.vx,R.y+=R.vy,R.x>t&&(R.x=0),R.x<0&&(R.x=t),R.y>i&&(R.y=0),R.y<0&&(R.y=i)}this._onTick.fire(this.getParticles()),requestAnimationFrame(U)};U()}getParticles(){return this._particles}}class gn{constructor(n){this.modelServer=n}listen(n,t){switch(t){case"onUpdate":return this.modelServer.onUpdate;case"onTick":return this.modelServer.onTick}return Be()}async call(n,t,i){switch(t){case"echo":return this.modelServer.echo();case"load":return this.modelServer.load(i);case"getParticles":return this.modelServer.getParticles()}Be()}}class Rn{constructor(){o(this,"modelService",new fn);const n=new Le,t=new gn(this.modelService);n.registerChannel("model",t),n.registerChannel("model2render",t)}async connect(n,t){n.postMessage({command:be.createMessageChannel,arg:t});const i=w.fromDOMEventEmitter(n,"message"),s=await w.toPromise(w.once(w.filter(i,_=>{const{data:l}=_;return l.command&&l.command===be.createMessageChannelResult&&l.arg===t})));return new an(s.ports[0],t)}getChannel(n,t){return pe(n.then(i=>i.getChannel(t)))}registerChannel(n,t,i){n.then(s=>s.registerChannel(t,i))}}new Rn})();
